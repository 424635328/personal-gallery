# .github/workflows/create-sync-pr.yml
# ç»ˆæä¼˜åŒ–ç‰ˆï¼šåˆ›å»ºä» test åˆ° main çš„åŒæ­¥ PR
# ä¿®æ­£ç‚¹ï¼š
# - å¢åŠ äº†è·å–å½“å‰æ—¥æœŸçš„æ­¥éª¤ï¼Œç”¨äº PR æ ‡é¢˜
# - ä¿®æ”¹äº† checkout é€»è¾‘ï¼Œä»¥é€‚åº” create-pull-request@v6 çš„æ–°ç”¨æ³•
# - ç§»é™¤äº†åœ¨æ–°ç‰ˆæœ¬ä¸­å·²åºŸå¼ƒçš„ 'head' å’Œ 'update' å‚æ•°

name: 'Sync: Create or Update Release PR'

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å‘¨ä¸€ä¸Šåˆ 9 ç‚¹ï¼ˆUTC æ—¶é—´å‡Œæ™¨ 1 ç‚¹ï¼‰è¿è¡Œ
    - cron: '0 1 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create_pull_request:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # ğŸ‘‡ ä¿®å¤ç‚¹ 1 & 2: ä¸å†æ£€å‡ºé»˜è®¤åˆ†æ”¯ï¼Œè€Œæ˜¯ç›´æ¥æ£€å‡ºä½œä¸ºæºåˆ†æ”¯çš„ 'test'
      - name: Checkout 'test' branch
        uses: actions/checkout@v5
        with:
          ref: 'test'

      # ğŸ‘‡ ä¿®å¤ç‚¹ 1: æ–°å¢æ­¥éª¤ï¼Œè·å–å½“å‰æ—¥æœŸ
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create or Update Pull Request from test to main
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          # æ— éœ€æ‰‹åŠ¨æŒ‡å®š token
          commit-message: "chore(release): sync test branch to main"
          # ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„æ—¥æœŸ
          title: "ğŸš€ Release: Sync `test` to `main` for ${{ steps.date.outputs.date }}"
          body: |
            This is an automated weekly PR to sync changes from the `test` branch to `main`.
            
            Please review the changes carefully before merging. All automated checks must pass.
            
            * **Source Branch:** `test`
            * **Target Branch:** `main`
            
            > **Note:** This PR will be updated automatically if new commits are pushed to the `test` branch.
          # ğŸ‘‡ ä¿®å¤ç‚¹ 2: 'base' å‚æ•°ä»ç„¶éœ€è¦ï¼Œç”¨æ¥æŒ‡å®šç›®æ ‡åˆ†æ”¯
          base: main
          # ğŸ‘‡ ä¿®å¤ç‚¹ 2 & 3: ç§»é™¤å·²åºŸå¼ƒçš„ 'head' å’Œ 'update' å‚æ•°
          labels: "release, automated-pr"
          assignees: "424635328"
          reviewers: "424635328"
          draft: false

      - name: Output PR Information
        if: steps.cpr.outputs.pull-request-number
        run: |
          echo "Pull Request Number: ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL: ${{ steps.cpr.outputs.pull-request-url }}"