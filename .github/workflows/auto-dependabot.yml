# .github/workflows/auto-dependabot.yml
# ‚ÄúÂ§©ÊñáÂè∞‚ÄùÊ®°ÂºèÁªàÊûÅÂ∑•‰ΩúÊµÅÔºåÁî®‰∫éÂÖ®Ëá™Âä®Â§ÑÁêÜ Dependabot PR„ÄÇ
# ÁªèËøáÂÅ•Â£ÆÊÄß‰ºòÂåñÔºåÂåÖÂê´‰∏•Ê†ºÊ®°Âºè„ÄÅ‰æùËµñÊ£ÄÊü•ÂíåËØ¶ÁªÜÊó•Âøó„ÄÇ

name: Dependabot Observatory

on:
  workflow_run:
    workflows: ["Universal Diagnostic CI"]
    types:
      - completed

jobs:
  handle_dependabot_pr:
    # Á°Æ‰øùÊòØÁî± dependabot Ëß¶ÂèëÔºåÂπ∂‰∏îÁ°ÆÂÆûÂÖ≥ËÅî‰∫Ü‰∏Ä‰∏™ PR
    if: >
      github.event.workflow_run.actor.login == 'dependabot[bot]' &&
      github.event.workflow_run.pull_requests[0]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      statuses: read

    steps:
      - name: "Setup: Verify Dependencies"
        run: |
          set -euo pipefail
          echo "Checking for required tools..."
          gh --version
          jq --version
          echo "‚úÖ All dependencies are available."

      - name: "Step 1: Extract PR Information"
        id: pr-info
        run: |
          set -euo pipefail
          echo "üîç Extracting PR information from workflow run..."
          
          # ‰ªé‰∫ã‰ª∂‰∏ä‰∏ãÊñá‰∏≠Ëé∑Âèñ PR ÁºñÂè∑
          PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          if [ -z "$PR_NUMBER" ]; then
            echo "‚ùå ERROR: Could not find an associated PR number."
            exit 1
          fi
          echo "PR Number: $PR_NUMBER"
          
          # ‰ΩøÁî® gh cli Ëé∑Âèñ PR ÁöÑ head SHA Âíå base branch
          # Ê≥®ÊÑèÔºöÊâÄÊúâÂèòÈáèÂºïÁî®ÈÉΩ‰ΩøÁî®ÂèåÂºïÂè∑ÔºåÂ¢ûÂº∫ÂÅ•Â£ÆÊÄß
          echo "Fetching PR details using GitHub CLI..."
          PR_HEAD_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
          BASE_BRANCH=$(gh pr view "$PR_NUMBER" --json baseRefName --jq '.baseRefName')

          echo "PR Head SHA: $PR_HEAD_SHA"
          echo "Base Branch: $BASE_BRANCH"

          # Â∞ÜÊèêÂèñÁöÑ‰ø°ÊÅØËæìÂá∫ÁªôÂêéÁª≠Ê≠•È™§‰ΩøÁî®
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_head_sha=$PR_HEAD_SHA" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Step 2: Observatory - Check Branch Protection Rules"
        id: observatory
        run: |
          set -euo pipefail
          echo "üî≠ Observing PR #${{ steps.pr-info.outputs.pr_number }} for branch '${{ steps.pr-info.outputs.base_branch }}'..."
          
          echo "Fetching branch protection rules..."
          REQUIRED_CHECKS=$(gh api "repos/${{ github.repository }}/branches/${{ steps.pr-info.outputs.base_branch }}/protection" --jq '.required_status_checks.contexts[]' | jq -r 'select(. != null)' || true)
          
          if [ -z "$REQUIRED_CHECKS" ]; then
            echo "‚úÖ No required status checks found in branch protection rules. Gatekeeper passes by default."
            echo "observatory_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Required checks according to branch protection rules:"
          echo "$REQUIRED_CHECKS"

          echo "Fetching actual check runs for commit: ${{ steps.pr-info.outputs.pr_head_sha }}"
          ALL_CHECKS_JSON=$(gh api "repos/${{ github.repository }}/commits/${{ steps.pr-info.outputs.pr_head_sha }}/check-runs" --jq '.check_runs[] | {name: .name, conclusion: .conclusion}')
          echo "Actual checks found on commit:"
          echo "$ALL_CHECKS_JSON"

          ALL_PASS=true
          while IFS= read -r CHECK_NAME; do
            # ‰ΩøÁî® jq ÁöÑ --arg Êù•ÂÆâÂÖ®Âú∞‰º†ÈÄíÂèòÈáè
            CONCLUSION=$(echo "$ALL_CHECKS_JSON" | jq -r --arg name "$CHECK_NAME" 'select(.name == $name) | .conclusion')
            
            if [[ "$CONCLUSION" == "success" ]]; then
              echo "‚úÖ SUCCESS: Required check '$CHECK_NAME' passed."
            else
              echo "‚ùå FAILURE: Required check '$CHECK_NAME' did not pass. Status: '${CONCLUSION:-Not Run or Still Pending}'."
              ALL_PASS=false
            fi
          done <<< "$REQUIRED_CHECKS"
          
          if $ALL_PASS; then
            echo "Final Result: All required checks passed."
            echo "observatory_passed=true" >> $GITHUB_OUTPUT
          else
            echo "Final Result: One or more required checks failed or are pending."
            echo "observatory_passed=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "Step 3: Get Dependabot Metadata"
        id: dependabot-metadata
        if: steps.observatory.outputs.observatory_passed == 'true'
        uses: dependabot/fetch-metadata@v2.2.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: "Step 4: Handle Successful Checks (Non-Major Update)"
        if: >
          steps.observatory.outputs.observatory_passed == 'true' &&
          steps.dependabot-metadata.outputs.update-type != 'version-update:semver-major'
        run: |
          set -euo pipefail
          echo "‚úÖ Observatory reports all checks passed for a non-major update."
          echo "Enabling auto-merge for PR #${{ steps.pr-info.outputs.pr_number }}..."
          gh pr merge "${{ steps.pr-info.outputs.pr_number }}" --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: "Step 5: Handle Successful Checks (Major Update)"
        if: >
          steps.observatory.outputs.observatory_passed == 'true' &&
          steps.dependabot-metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          set -euo pipefail
          echo "‚ö†Ô∏è Observatory reports all checks passed, but this is a major update."
          echo "Adding a comment to PR #${{ steps.pr-info.outputs.pr_number }} to request manual review."
          gh pr comment "${{ steps.pr-info.outputs.pr_number }}" --body "‚úÖ The Observatory confirms all required branch protection checks have passed, but this is a **major** version update. It requires manual review and approval."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Step 6: Handle Failed Checks"
        if: steps.observatory.outputs.observatory_passed == 'false'
        run: |
          set -euo pipefail
          echo "‚ùå Observatory reports one or more required checks failed or are pending."
          echo "Closing PR #${{ steps.pr-info.outputs.pr_number }}..."
          WORKFLOW_URL="https://github.com/${{ github.repository }}/pull/${{ steps.pr-info.outputs.pr_number }}/checks"
          COMMENT_BODY="üö® The Observatory reports that one or more **required branch protection checks** have failed or are still pending. I am closing this PR automatically.\n\nPlease review the full list of checks and their logs here: **[All PR Checks](${WORKFLOW_URL})**."
          gh pr comment "${{ steps.pr-info.outputs.pr_number }}" --body "$COMMENT_BODY"
          gh pr close "${{ steps.pr-info.outputs.pr_number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}