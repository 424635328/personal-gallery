# .github/workflows/auto-dependabot.yml

# ========================================================================================
# Dependabot Observatory: å…¨è‡ªåŠ¨ Dependabot PR å¤„ç†å·¥ä½œæµ
# ========================================================================================
#
# è¿™æ˜¯ä¸€ä¸ªé«˜çº§å·¥ä½œæµï¼Œç”¨äºå…¨è‡ªåŠ¨ç®¡ç† Dependabot æäº¤çš„æ‹‰å–è¯·æ±‚ï¼ˆPRï¼‰ã€‚
# å®ƒæ‰®æ¼”ç€â€œå¤©æ–‡å°â€ï¼ˆObservatoryï¼‰çš„è§’è‰²ï¼Œåœ¨æ‰€æœ‰CIæ£€æŸ¥å®Œæˆåï¼Œæ™ºèƒ½åœ°å†³å®šæ˜¯
# è‡ªåŠ¨åˆå¹¶ã€è¯·æ±‚äººå·¥å®¡æŸ¥è¿˜æ˜¯å…³é—­PRã€‚
#
# æ ¸å¿ƒç‰¹æ€§ï¼š
#   - é¿å…ç«æ€æ¡ä»¶ï¼šä½¿ç”¨ `check_suite` è§¦å‘å™¨ï¼Œç¡®ä¿åœ¨æ‰€æœ‰æ£€æŸ¥å®Œæˆåæ‰è¿è¡Œã€‚
#   - éµå®ˆåˆ†æ”¯ä¿æŠ¤ï¼šä¸¥æ ¼æ ¸å¯¹åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸­å®šä¹‰çš„æ‰€æœ‰å¿…éœ€æ£€æŸ¥é¡¹ã€‚
#   - æ™ºèƒ½å†³ç­–ï¼š
#     - è‡ªåŠ¨åˆå¹¶ï¼šæ‰€æœ‰æ£€æŸ¥é€šè¿‡ä¸”ä¸ºéé‡å¤§ç‰ˆæœ¬æ›´æ–°ï¼ˆpatch, minorï¼‰ã€‚
#     - è¯·æ±‚å®¡æŸ¥ï¼šæ‰€æœ‰æ£€æŸ¥é€šè¿‡ä½†ä¸ºé‡å¤§ç‰ˆæœ¬æ›´æ–°ï¼ˆmajorï¼‰ã€‚
#     - è‡ªåŠ¨å…³é—­ï¼šä»»ä½•å¿…éœ€çš„æ£€æŸ¥å¤±è´¥ã€‚
#   - å¥å£®æ€§è®¾è®¡ï¼šåŒ…å«ä¸¥æ ¼æ¨¡å¼ï¼ˆset -euo pipefailï¼‰å’Œæ¸…æ™°çš„æ—¥å¿—è¾“å‡ºã€‚
#
name: Dependabot Observatory

# ----------------------------------------------------------------------------------------
# è§¦å‘å™¨ï¼ˆTriggerï¼‰
# ----------------------------------------------------------------------------------------
# ä½¿ç”¨ `check_suite` çš„ `completed` äº‹ä»¶ä½œä¸ºè§¦å‘å™¨ã€‚
# è¿™æ ·åšæ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªå¸¸è§çš„ç«æ€æ¡ä»¶é—®é¢˜ï¼šå¦‚æœä½¿ç”¨ `pull_request` è§¦å‘å™¨ï¼Œ
# æœ¬å·¥ä½œæµå¯èƒ½ä¼šåœ¨å…¶ä»–å¿…éœ€çš„CIæ£€æŸ¥ï¼ˆå¦‚æµ‹è¯•ã€æ„å»ºï¼‰å®Œæˆä¹‹å‰å°±å¼€å§‹æ‰§è¡Œï¼Œ
# ä»è€Œå¯¼è‡´å¯¹æ£€æŸ¥çŠ¶æ€çš„é”™è¯¯åˆ¤æ–­ã€‚
# `check_suite: completed` ä¿è¯äº†æ­¤å·¥ä½œæµåªåœ¨ä¸æäº¤å…³è”çš„æ‰€æœ‰æ£€æŸ¥éƒ½ç»“æŸåæ‰å¯åŠ¨ã€‚
on:
  check_suite:
    types:
      - completed

# ----------------------------------------------------------------------------------------
# å¹¶å‘æ§åˆ¶ï¼ˆConcurrencyï¼‰
# ----------------------------------------------------------------------------------------
# ä¸ºæ¯ä¸ª PR è®¾ç½®ç‹¬ç«‹çš„å¹¶å‘ç»„ï¼Œä»¥é˜²æ­¢å¯¹åŒä¸€ä¸ª PR åŒæ—¶è¿è¡Œå¤šä¸ªå·¥ä½œæµå®ä¾‹ã€‚
# - group: åŸºäºä»“åº“å’Œ PR ç¼–å·åˆ›å»ºå”¯ä¸€åˆ†ç»„é”®ã€‚
#   `github.event.check_suite.pull_requests[0].number` ä» check_suite äº‹ä»¶ä¸­å®‰å…¨åœ°è·å– PR ç¼–å·ã€‚
# - cancel-in-progress: å¦‚æœä¸€ä¸ªæ–°çš„å·¥ä½œæµå®ä¾‹ï¼ˆä¾‹å¦‚ï¼Œç”±äºæ–°çš„æäº¤ï¼‰åœ¨åŒä¸€ä¸ªç»„ä¸­å¯åŠ¨ï¼Œ
#   ä¼šè‡ªåŠ¨å–æ¶ˆå½“å‰æ­£åœ¨è¿è¡Œçš„å®ä¾‹ï¼Œç¡®ä¿æ€»æ˜¯å¤„ç†æœ€æ–°çš„çŠ¶æ€ã€‚
concurrency:
  group: ${{ github.repository }}-${{ github.event.check_suite.pull_requests[0].number }}-observatory
  cancel-in-progress: true

jobs:
  handle_dependabot_pr:
    # ------------------------------------------------------------------------------------
    # ä½œä¸šæ‰§è¡Œæ¡ä»¶ï¼ˆJob Conditionï¼‰
    # ------------------------------------------------------------------------------------
    # æ­¤ä½œä¸šä»…åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ—¶è¿è¡Œï¼š
    # 1. `github.actor == 'dependabot[bot]'`: ç¡®ä¿äº‹ä»¶æ˜¯ç”± Dependabot è§¦å‘çš„ã€‚
    # 2. `github.event.check_suite.pull_requests[0]`: ç¡®ä¿è¯¥ check_suite äº‹ä»¶ç¡®å®ä¸ä¸€ä¸ª PR å…³è”ã€‚
    #    ï¼ˆæŸäº› check_suite å¯èƒ½ä¸ç‹¬ç«‹çš„æäº¤ç›¸å…³ï¼Œè€Œæ²¡æœ‰å…³è”çš„ PRï¼‰ã€‚
    if: >
      github.actor == 'dependabot[bot]' &&
      github.event.check_suite.pull_requests[0]
    runs-on: ubuntu-latest
    
    # ------------------------------------------------------------------------------------
    # æƒé™ï¼ˆPermissionsï¼‰
    # ------------------------------------------------------------------------------------
    # ä¸ºä½œä¸šæˆäºˆå®Œæˆå…¶ä»»åŠ¡æ‰€éœ€çš„æœ€å°æƒé™ã€‚
    permissions:
      pull-requests: write # å…è®¸è¯„è®ºã€åˆå¹¶å’Œå…³é—­ PRã€‚
      contents: write      # å…è®¸åˆå¹¶ PR (å› ä¸ºåˆå¹¶æ“ä½œä¼šå†™å…¥ base åˆ†æ”¯)ã€‚

    steps:
      - name: "Checkout: å…‹éš†ä»£ç ä»“åº“"
        uses: actions/checkout@v5

      - name: "Setup: æ ¡éªŒä¾èµ–å·¥å…·"
        run: |
          # å¯ç”¨ Shell çš„ä¸¥æ ¼æ¨¡å¼ï¼Œç¡®ä¿è„šæœ¬åœ¨å‡ºé”™æ—¶ç«‹å³å¤±è´¥ã€‚
          # -e: å¦‚æœå‘½ä»¤è¿”å›éé›¶é€€å‡ºç ï¼Œåˆ™ç«‹å³é€€å‡ºã€‚
          # -u: å°†æœªè®¾ç½®çš„å˜é‡è§†ä¸ºé”™è¯¯ã€‚
          # -o pipefail: å¦‚æœç®¡é“ä¸­çš„ä»»ä½•å‘½ä»¤å¤±è´¥ï¼Œåˆ™æ•´ä¸ªç®¡é“çš„é€€å‡ºç ä¸ºéé›¶ã€‚
          set -euo pipefail
          echo "æ­£åœ¨æ£€æŸ¥æ‰€éœ€å·¥å…·ï¼ˆgh, jqï¼‰..."
          gh --version
          jq --version
          echo "âœ… æ‰€æœ‰ä¾èµ–å·¥å…·å‡å¯ç”¨ã€‚"

      - name: "Step 1: æå– PR å…³é”®ä¿¡æ¯"
        id: pr-info
        # ä» check_suite äº‹ä»¶è´Ÿè½½ä¸­æå– PR ç¼–å·å’Œå¤´éƒ¨æäº¤ SHAã€‚
        # ç”±äºäº‹ä»¶ä¸­ä¸åŒ…å« base åˆ†æ”¯ä¿¡æ¯ï¼Œéœ€è¦ä½¿ç”¨ GitHub CLI é¢å¤–æŸ¥è¯¢ã€‚
        run: |
          set -euo pipefail
          echo "ğŸ” ä» check_suite äº‹ä»¶ä¸­æå– PR ä¿¡æ¯..."

          PR_NUMBER="${{ github.event.check_suite.pull_requests[0].number }}"
          PR_HEAD_SHA="${{ github.event.check_suite.head_sha }}"
          
          if [ -z "$PR_NUMBER" ] || [ -z "$PR_HEAD_SHA" ]; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•ä»äº‹ä»¶ä¸­æ‰¾åˆ°å…³è”çš„ PR ç¼–å·æˆ–å¤´éƒ¨æäº¤ SHAã€‚"
            exit 1
          fi
          echo "PR ç¼–å·: $PR_NUMBER"
          echo "PR å¤´éƒ¨æäº¤ SHA: $PR_HEAD_SHA"
          
          echo "æ­£åœ¨ä½¿ç”¨ GitHub CLI è·å– base åˆ†æ”¯åç§°..."
          BASE_BRANCH=$(gh pr view "$PR_NUMBER" --json baseRefName --jq '.baseRefName')
          echo "Base åˆ†æ”¯: $BASE_BRANCH"

          # å°†æå–çš„ä¿¡æ¯è®¾ç½®ä¸ºåç»­æ­¥éª¤å¯ç”¨çš„è¾“å‡ºå˜é‡ã€‚
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_head_sha=$PR_HEAD_SHA" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Step 2: Observatory - æ£€æŸ¥åˆ†æ”¯ä¿æŠ¤è§„åˆ™"
        id: observatory
        # è¿™æ˜¯å·¥ä½œæµçš„æ ¸å¿ƒï¼Œå³â€œå¤©æ–‡å°â€æ­¥éª¤ã€‚å®ƒæ¨¡æ‹Ÿä¸€ä¸ªâ€œå®ˆé—¨å‘˜â€ï¼Œç¡®ä¿ PR æ»¡è¶³æ‰€æœ‰åˆ†æ”¯ä¿æŠ¤è¦æ±‚ã€‚
        # é€»è¾‘å¦‚ä¸‹ï¼š
        # 1. è·å–ç›®æ ‡ base åˆ†æ”¯ä¸Šè®¾ç½®çš„æ‰€æœ‰â€œå¿…éœ€çŠ¶æ€æ£€æŸ¥â€ (required status checks)ã€‚
        # 2. å¦‚æœæ²¡æœ‰è®¾ç½®å¿…éœ€æ£€æŸ¥ï¼Œåˆ™é»˜è®¤è§†ä¸ºé€šè¿‡ã€‚
        # 3. è·å–å½“å‰ PR å¤´éƒ¨æäº¤ä¸Šçš„æ‰€æœ‰å®é™…æ£€æŸ¥è¿è¡Œ (check-runs) åŠå…¶æœ€ç»ˆç»“è®ºã€‚
        # 4. éå†æ¯ä¸€ä¸ªâ€œå¿…éœ€æ£€æŸ¥â€ï¼ŒéªŒè¯å…¶åœ¨â€œå®é™…æ£€æŸ¥â€ä¸­çš„ç»“è®ºæ˜¯å¦ä¸º 'success'ã€‚
        #    - å› ä¸ºæ­¤å·¥ä½œæµç”± `check_suite: completed` è§¦å‘ï¼Œæ‰€ä»¥æ£€æŸ¥çŠ¶æ€ä¸åº”ä¸º 'pending'ã€‚
        run: |
          set -euo pipefail
          echo "ğŸ”­ [Observatory] æ­£åœ¨è§‚æµ‹ PR #${{ steps.pr-info.outputs.pr_number }} (ç›®æ ‡åˆ†æ”¯: '${{ steps.pr-info.outputs.base_branch }}')..."
          
          echo "è·å–åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸­çš„å¿…éœ€æ£€æŸ¥é¡¹..."
          # å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼ˆä¾‹å¦‚ï¼Œåˆ†æ”¯æ²¡æœ‰ä¿æŠ¤è§„åˆ™ï¼‰ï¼Œåˆ™é»˜è®¤ä¸ºç©ºæ•°ç»„ "[]"ã€‚
          REQUIRED_CHECKS_JSON=$(gh api "repos/${{ github.repository }}/branches/${{ steps.pr-info.outputs.base_branch }}/protection" --jq '.required_status_checks.contexts' 2>/dev/null || echo "[]")
          
          if [[ "$(echo "$REQUIRED_CHECKS_JSON" | jq 'if type=="array" and length==0 then "empty" else "ok" end')" == '"empty"' ]]; then
            echo "âœ… åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸­æœªå‘ç°å¿…éœ€çš„çŠ¶æ€æ£€æŸ¥ã€‚é»˜è®¤é€šè¿‡ã€‚"
            echo "observatory_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          REQUIRED_CHECKS=$(echo "$REQUIRED_CHECKS_JSON" | jq -r '.[]')
          echo "åˆ†æ”¯ä¿æŠ¤è§„åˆ™è¦æ±‚çš„æ£€æŸ¥é¡¹:"
          echo "$REQUIRED_CHECKS"

          echo "è·å–æäº¤ (${{ steps.pr-info.outputs.pr_head_sha }}) ä¸Šçš„å®é™…æ£€æŸ¥è¿è¡Œç»“æœ..."
          ALL_CHECKS_JSON=$(gh api "repos/${{ github.repository }}/commits/${{ steps.pr-info.outputs.pr_head_sha }}/check-runs" --jq '.check_runs')
          echo "åœ¨è¯¥æäº¤ä¸Šå‘ç°çš„å®é™…æ£€æŸ¥é¡¹åŠå…¶ç»“è®º:"
          echo "$ALL_CHECKS_JSON" | jq '.[] | {name: .name, conclusion: .conclusion}'

          ALL_PASS=true
          while IFS= read -r CHECK_NAME; do
            # å¯¹äºæ¯ä¸ªå¿…éœ€çš„æ£€æŸ¥ï¼Œä»æ‰€æœ‰å®é™…è¿è¡Œçš„æ£€æŸ¥ä¸­æ‰¾åˆ°å…¶æœ€ç»ˆç»“è®ºã€‚
            # `tail -n 1` ç”¨äºå¤„ç†åŒä¸€æ£€æŸ¥å¯èƒ½è¢«å¤šæ¬¡è¿è¡Œï¼ˆå¦‚é‡è¯•ï¼‰çš„æƒ…å†µï¼Œç¡®ä¿å–æœ€æ–°ç»“æœã€‚
            CONCLUSION=$(echo "$ALL_CHECKS_JSON" | jq -r --arg name "$CHECK_NAME" '(.[] | select(.name == $name)) | .conclusion' | tail -n 1)
            
            if [[ "$CONCLUSION" == "success" ]]; then
              echo "âœ… é€šè¿‡: å¿…éœ€æ£€æŸ¥ '$CHECK_NAME' å·²æˆåŠŸã€‚"
            else
              echo "âŒ å¤±è´¥: å¿…éœ€æ£€æŸ¥ '$CHECK_NAME' æœªé€šè¿‡ã€‚çŠ¶æ€: '${CONCLUSION:-Not Found}'."
              ALL_PASS=false
            fi
          done <<< "$REQUIRED_CHECKS"
          
          if $ALL_PASS; then
            echo "æœ€ç»ˆç»“è®º: æ‰€æœ‰å¿…éœ€æ£€æŸ¥å‡å·²é€šè¿‡ã€‚"
            echo "observatory_passed=true" >> $GITHUB_OUTPUT
          else
            echo "æœ€ç»ˆç»“è®º: ä¸€ä¸ªæˆ–å¤šä¸ªå¿…éœ€æ£€æŸ¥å¤±è´¥ã€‚"
            echo "observatory_passed=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "Step 3: è·å– Dependabot å…ƒæ•°æ®"
        # ä»…åœ¨æ‰€æœ‰æ£€æŸ¥é€šè¿‡æ—¶æ‰éœ€è¦è·å–æ›´æ–°ç±»å‹ã€‚
        if: steps.observatory.outputs.observatory_passed == 'true'
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2.2.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: "Step 4: [åœºæ™¯] æ£€æŸ¥é€šè¿‡ï¼Œéé‡å¤§æ›´æ–° -> è‡ªåŠ¨åˆå¹¶"
        # æ¡ä»¶ï¼šå¤©æ–‡å°æ£€æŸ¥é€šè¿‡ï¼Œä¸”ä¾èµ–æ›´æ–°ç±»å‹ä¸æ˜¯ semver-majorã€‚
        if: >
          steps.observatory.outputs.observatory_passed == 'true' &&
          steps.dependabot-metadata.outputs.update-type != 'version-update:semver-major'
        run: |
          set -euo pipefail
          echo "âœ… æ‰€æœ‰æ£€æŸ¥å·²é€šè¿‡ï¼Œä¸”ä¸ºéé‡å¤§æ›´æ–°ï¼ˆ${{ steps.dependabot-metadata.outputs.update-type }}ï¼‰ã€‚"
          echo "æ­£åœ¨ä¸º PR #${{ steps.pr-info.outputs.pr_number }} å¯ç”¨è‡ªåŠ¨åˆå¹¶..."
          gh pr merge "${{ steps.pr-info.outputs.pr_number }}" --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: "Step 5: [åœºæ™¯] æ£€æŸ¥é€šè¿‡ï¼Œä½†ä¸ºé‡å¤§æ›´æ–° -> è¯·æ±‚äººå·¥å®¡æŸ¥"
        # æ¡ä»¶ï¼šå¤©æ–‡å°æ£€æŸ¥é€šè¿‡ï¼Œä½†ä¾èµ–æ›´æ–°ç±»å‹æ˜¯ semver-majorã€‚
        if: >
          steps.observatory.outputs.observatory_passed == 'true' &&
          steps.dependabot-metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          set -euo pipefail
          echo "âš ï¸ æ‰€æœ‰æ£€æŸ¥å·²é€šè¿‡ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªé‡å¤§ç‰ˆæœ¬æ›´æ–°ã€‚"
          echo "æ­£åœ¨ PR #${{ steps.pr-info.outputs.pr_number }} ä¸­æ·»åŠ è¯„è®ºï¼Œè¯·æ±‚äººå·¥å®¡æŸ¥ã€‚"
          gh pr comment "${{ steps.pr-info.outputs.pr_number }}" --body "âœ… **å¤©æ–‡å°æŠ¥å‘Šï¼š** æ‰€æœ‰å¿…éœ€çš„åˆ†æ”¯ä¿æŠ¤æ£€æŸ¥å‡å·²é€šè¿‡ã€‚

          ä½†è¿™æ˜¯ä¸€ä¸ª **é‡å¤§ç‰ˆæœ¬æ›´æ–°** (major version update)ï¼Œå¯èƒ½åŒ…å«ä¸å…¼å®¹çš„å˜æ›´ï¼Œéœ€è¦äººå·¥å®¡æŸ¥å’Œæ‰¹å‡†åæ‰èƒ½åˆå¹¶ã€‚"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Step 6: [åœºæ™¯] æ£€æŸ¥å¤±è´¥ -> è‡ªåŠ¨å…³é—­"
        # æ¡ä»¶ï¼šå¤©æ–‡å°æ£€æŸ¥æœªé€šè¿‡ã€‚
        if: steps.observatory.outputs.observatory_passed == 'false'
        run: |
          set -euo pipefail
          echo "âŒ ä¸€ä¸ªæˆ–å¤šä¸ªå¿…éœ€æ£€æŸ¥å¤±è´¥ã€‚"
          echo "æ­£åœ¨å…³é—­ PR #${{ steps.pr-info.outputs.pr_number }} å¹¶å‘è¡¨è¯„è®º..."
          WORKFLOW_URL="https://github.com/${{ github.repository }}/pull/${{ steps.pr-info.outputs.pr_number }}/checks"
          COMMENT_BODY="ğŸš¨ **å¤©æ–‡å°æŠ¥å‘Šï¼š** ä¸€ä¸ªæˆ–å¤šä¸ªå¿…éœ€çš„åˆ†æ”¯ä¿æŠ¤æ£€æŸ¥å¤±è´¥ã€‚æ­¤ PR å°†è¢«è‡ªåŠ¨å…³é—­ã€‚

          è¯·è®¿é—®ä»¥ä¸‹é“¾æ¥å®¡æŸ¥å¤±è´¥çš„æ£€æŸ¥é¡¹ï¼š
          **[æŸ¥çœ‹æ‰€æœ‰ PR æ£€æŸ¥](${WORKFLOW_URL})**"
          gh pr comment "${{ steps.pr-info.outputs.pr_number }}" --body "$COMMENT_BODY"
          gh pr close "${{ steps.pr-info.outputs.pr_number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}